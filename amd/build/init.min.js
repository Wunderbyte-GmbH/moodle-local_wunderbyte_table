define("local_wunderbyte_table/init",["exports","core/ajax","core/templates","core/notification","local_wunderbyte_table/filter","local_wunderbyte_table/search","local_wunderbyte_table/sort","local_wunderbyte_table/reload","local_wunderbyte_table/actionbutton","local_wunderbyte_table/edittable","./rowsdisplayselect","./filter","./filtersearch","core/str"],(function(_exports,_ajax,_templates,_notification,_filter,_search,_sort,_reload,_actionbutton,_edittable,_rowsdisplayselect,_filter2,_filtersearch,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * @package    local_wunderbyte_table
   * @copyright Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.queries=_exports.isHidden=_exports.init=_exports.callLoadData=_exports.SELECTORS=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);var loadings={},queries={};_exports.queries=queries;var scrollpages={},tablejss={},scrollingelement={},moreThanOneTable=!1;const SELECTORS={CONTAINER:".wunderbyte_table_container_",FILTER:" .wunderbyteTableFilter",WBTABLE:"wunderbyte-table-"};_exports.SELECTORS=SELECTORS;_exports.init=(idstring,encodedtable)=>{console.log("init booking "+idstring),queries[idstring]||checkInTable(idstring,encodedtable),Object.keys(queries).length>1&&(moreThanOneTable=!0),idstring&&encodedtable&&(scrollpages.hasOwnProperty(idstring)||(infinitescrollEnabled(idstring)?scrollpages[idstring]=0:scrollpages[idstring]=-1),function(idstring,encodedtable,callback){const identifier="a"+idstring;let element=document.querySelector("#"+identifier);if(!element||element.dataset.encodedtable)return void initializeComponents(idstring,encodedtable);element.dataset.encodedtable=encodedtable;let spinner=document.querySelector("#"+identifier+"spinner");if(null===spinner||isHidden(spinner)){const selector=".wunderbyte_table_container_"+idstring;null!=document.querySelector(selector)&&(addLinksToPagination(idstring,encodedtable,element),initializeComponents(idstring,encodedtable),addScrollFunctionality(idstring,encodedtable,element),(idstring=>{const togglebutton=document.querySelector("#asidecollapse_"+idstring);togglebutton&&togglebutton.addEventListener("click",(()=>{document.querySelector(".wunderbyte_table_container_"+idstring+" aside").classList.toggle("inactive");document.querySelector(".wunderbyte_table_container_"+idstring).classList.toggle("inactivefilter")}))})(idstring))}else{var observer=new MutationObserver((function(){isHidden(element)||(this.disconnect(),callback(idstring,encodedtable))}));const hiddenElement=returnHiddenElement(element);null!==hiddenElement?observer.observe(hiddenElement,{attributes:!0}):callback(idstring,encodedtable)}}(idstring,encodedtable,callLoadData))};function getScrollParent(node){return null===node?null:node.scrollHeight>node.clientHeight&&function(node){const styles=window.getComputedStyle(node);return"scroll"===styles.overflow||"auto"===styles.overflow}(node)?node:getScrollParent(node.parentNode)}const isHidden=el=>{var style=window.getComputedStyle(el);return"none"===style.display||"hidden"===style.visibility};_exports.isHidden=isHidden;const callLoadData=function(idstring,encodedtable){let page=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,tsort=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,thide=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,tshow=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,tdir=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,treset=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,filterobjects=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,searchtext=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,replacerow=arguments.length>10&&void 0!==arguments[10]&&arguments[10];if(loadings[idstring]&&!replacerow)return;null!==page&&(infinitescrollEnabled(idstring)?scrollpages[idstring]=page:scrollpages[idstring]=-1),null===filterobjects&&(filterobjects=(0,_filter.getFilterObjects)(idstring)),null===searchtext&&(searchtext=(0,_search.getSearchInput)(idstring)),null===tsort&&(tsort=(0,_sort.getSortSelection)(idstring));const table=document.getElementById("a"+idstring);!0!==moreThanOneTable&&table.childNodes.length>0&&(0,_filter2.updateUrlWithFilterSearchSort)(filterobjects,searchtext,tsort,tdir);let spinner=document.querySelector("#a"+idstring+"spinner .spinner-border");0!=scrollpages[idstring]||replacerow||spinner&&spinner.classList.remove("hidden"),checkInTable(idstring,encodedtable,page,tsort,thide,tshow,tdir,treset,filterobjects,searchtext,replacerow),loadings[idstring]=!0,_ajax.default.call([{methodname:"local_wunderbyte_table_load_data",args:{encodedtable:encodedtable,page:page,tsort:tsort,thide:thide,tshow:tshow,tdir:tdir,treset:treset,wbtfilter:filterobjects,searchtext:searchtext},done:async function(res){let jsonobject="";try{jsonobject=JSON.parse(res.content)}catch(e){const message=await(0,_str.get_string)("couldnotloaddata","local_wunderbyte_table");return _notification.default.addNotification({message:message,type:"danger"}),loadings[idstring]=!1,void console.log(e)}let rendertemplate=res.template,container=document.querySelector(".wunderbyte_table_container_"+idstring);if(!container)return;const componentscontainer=container.querySelector(".wunderbyte_table_components");if(replacerow||scrollpages[idstring]>0){const rowtemplate=rendertemplate+"_row";if(!jsonobject.table.hasOwnProperty("rows"))return scrollpages[idstring]=-1,void(loadings[idstring]=!1);const promises=jsonobject.table.rows.map((row=>(_templates.default.renderForPromise(rowtemplate,row).then((_ref=>{let{html:html,js:js}=_ref;if(replacerow){const rowid=JSON.parse(filterobjects).id;_templates.default.replaceNode("#a"+idstring+" .rows-container tr[data-id='"+rowid+"']",html,js)}else _templates.default.appendNodeContents("#a"+idstring+" .rows-container",html,js);return!0})).catch((e=>{console.log(e)})),!0)));if(!tablejss.hasOwnProperty(idstring)){const promise=returnPromiseToSaveJS(rendertemplate,jsonobject,idstring);promises.push(promise)}return void Promise.all(promises).then((()=>{setTimeout((()=>{_templates.default.appendNodeContents("#a"+idstring,"",tablejss[idstring])}),100),loadings[idstring]=!1})).catch((e=>{console.log(e)}))}const promises=[];if(componentscontainer){const sortselector=".wunderbyteTableSelect";promises.push(_templates.default.renderForPromise("local_wunderbyte_table/component_sort",jsonobject).then((_ref2=>{let{html:html,js:js}=_ref2;const element=container.querySelector(sortselector);return _templates.default.replaceNode(element,html,js),initializeComponents(idstring,encodedtable),!0})).catch((ex=>{console.log(ex)})))}else rendertemplate+="_container";let frag=container.querySelector(".wunderbyteTableClass"),rows=jsonobject.table.rows;tsort&&(!rows||rows.length<1)?(spinner&&spinner.classList.add("hidden"),table&&table.classList.remove("hidden"),loadings[idstring]=!1):promises.push(_templates.default.renderForPromise(rendertemplate,jsonobject).then((_ref3=>{let{html:html,js:js}=_ref3;if(componentscontainer){for(;frag.firstChild;)frag.removeChild(frag.lastChild);_templates.default.appendNodeContents("#a"+idstring,html,js)}else{const parent=container.parentElement;container.remove(),_templates.default.appendNodeContents(parent,html,js),container=document.querySelector(".wunderbyte_table_container_"+idstring)}if(null==container)return!0;if(addLinksToPagination(idstring,encodedtable,container),loadings[idstring]=!1,spinner&&spinner.classList.add("hidden"),table&&table.classList.remove("hidden"),initializeComponents(idstring,encodedtable),!container)return!0;const element=container.querySelector("#a"+idstring);return addScrollFunctionality(idstring,encodedtable,element),!0})).catch((ex=>{loadings[idstring]=!1,_notification.default.addNotification({message:"failed rendering "+ex,type:"danger"})})));await promises[0],await promises[1]},fail:function(err){if(1!=treset)callLoadData(idstring,encodedtable,page,null,null,null,null,1);else{let node=document.createElement("DIV"),textnode=document.createTextNode(err.message);node.appendChild(textnode),table.appendChild(node),spinner.classList.add("hidden"),table.classList.remove("hidden")}}}])};function addScrollFunctionality(idstring,encodedtable,element){if(!infinitescrollEnabled(idstring))return;if(element.dataset.scrollinitialized)return;element.dataset.scrollinitialized=!0;const scrollableelement=getScrollParent(element);scrollableelement&&scrollableelement.addEventListener("scroll",(()=>{scrollingelement.hasOwnProperty(idstring)?"scrollElement"===scrollingelement[idstring]&&scrollListener(element,idstring,encodedtable):scrollingelement[idstring]="scrollElement"})),window.addEventListener("scroll",(()=>{scrollingelement.hasOwnProperty(idstring)?"window"===scrollingelement[idstring]&&scrollListener(element,idstring,encodedtable):scrollingelement[idstring]="window"}))}function scrollListener(element,idstring,encodedtable){if(returnHiddenElement(element))return;const elementtop=element.getBoundingClientRect().top,screenheight=document.body.scrollHeight;const tableelement=document.querySelector(".wunderbyte_table_container_"+idstring).querySelector('[class^="'+SELECTORS.WBTABLE+'"]');if(!tableelement)return;const tableelementheight=tableelement.getBoundingClientRect().height;!loadings[idstring]&&scrollpages[idstring]>=0&&elementtop+tableelementheight-screenheight<0&&(scrollpages[idstring]=scrollpages[idstring]+1,callLoadData(idstring,encodedtable,scrollpages[idstring],null,null,null,null,null,null,null))}function returnHiddenElement(element){for(;null!==element;){if(isHidden(element))return element;element=element.parentElement}return null}function addLinksToPagination(idstring,encodedtable,frag){if(frag){var arrayOfPageItems=frag.querySelectorAll(".page-item");arrayOfPageItems&&0!=arrayOfPageItems.length&&arrayOfPageItems.forEach((item=>{let pageNumber=item.dataset.pagenumber;pageNumber&&(--pageNumber,item.addEventListener("click",(()=>{callLoadData(idstring,encodedtable,pageNumber)})))}))}}function infinitescrollEnabled(idstring){const selector=".wunderbyte_table_container_"+idstring;return!!document.querySelector(selector+" div.infinitescroll_enabled")}function initializeComponents(idstring,encodedtable){const selector=".wunderbyte_table_container_"+idstring;(0,_filter.initializeCheckboxes)(selector,idstring,encodedtable),(0,_search.initializeSearch)(selector,idstring,encodedtable),(0,_sort.initializeSort)(selector,idstring,encodedtable),(0,_rowsdisplayselect.initializeRowsSelect)(selector,idstring,encodedtable),(0,_filtersearch.initializeFilterSearch)(selector,idstring,encodedtable),(0,_filter2.initializeResetFilterButton)(selector,idstring,encodedtable),(0,_edittable.initializeEditTableButton)(selector,idstring,encodedtable),_reload.initializeReload&&(0,_reload.initializeReload)(selector,idstring,encodedtable),(0,_actionbutton.initializeActionButton)(selector,idstring,encodedtable)}function returnPromiseToSaveJS(rendertemplate,jsonobject,idstring){return _templates.default.renderForPromise(rendertemplate,jsonobject).then((_ref4=>{let{html:html,js:js}=_ref4;return tablejss[idstring]=js,!0})).catch((e=>{console.log(e)}))}function checkInTable(idstring,encodedtable){let page=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,tsort=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,thide=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,tshow=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,tdir=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,treset=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,filterobjects=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,searchtext=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,replacerow=arguments.length>10&&void 0!==arguments[10]&&arguments[10];replacerow||(queries[idstring]={idstring:idstring,encodedtable:encodedtable,page:page,tsort:tsort,thide:thide,tshow:tshow,tdir:tdir,treset:treset,filterobjects:filterobjects,searchtext:searchtext,replacerow:!1})}_exports.callLoadData=callLoadData}));

//# sourceMappingURL=init.min.js.map