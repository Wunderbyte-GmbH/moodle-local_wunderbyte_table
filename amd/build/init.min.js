define("local_wunderbyte_table/init",["exports","core/ajax","core/templates","core/notification","local_wunderbyte_table/filter","local_wunderbyte_table/search","local_wunderbyte_table/sort","local_wunderbyte_table/reload","local_wunderbyte_table/actionbutton","./rowsdisplayselect","./filter"],(function(_exports,_ajax,_templates,_notification,_filter,_search,_sort,_reload,_actionbutton,_rowsdisplayselect,_filter2){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.queries=_exports.isHidden=_exports.init=_exports.callLoadData=_exports.SELECTORS=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);var loadings={},queries={};_exports.queries=queries;var scrollpages={},tablejss={},scrollingelement={},moreThanOneTable=!1;_exports.SELECTORS={CONTAINER:".wunderbyte_table_container_",FILTER:" .wunderbyteTableFilter"};_exports.init=function(idstring,encodedtable){console.log("init booking "+idstring),queries[idstring]||checkInTable(idstring,encodedtable),Object.keys(queries).length>1&&(moreThanOneTable=!0),idstring&&encodedtable&&(scrollpages.hasOwnProperty(idstring)||(infinitescrollEnabled(idstring)?scrollpages[idstring]=0:scrollpages[idstring]=-1),function(idstring,encodedtable,callback){var identifier="a"+idstring,element=document.querySelector("#"+identifier);if(!element||element.dataset.encodedtable)return void initializeComponents(idstring,encodedtable);element.dataset.encodedtable=encodedtable;var spinner=document.querySelector("#"+identifier+"spinner");if(null===spinner||isHidden(spinner))addLinksToPagination(idstring,encodedtable,element),initializeComponents(idstring,encodedtable),addScrollFunctionality(idstring,encodedtable,element),function(idstring){var togglebutton=document.querySelector("#asidecollapse_"+idstring);togglebutton&&togglebutton.addEventListener("click",(function(){document.querySelector(".wunderbyte_table_container_"+idstring+" aside").classList.toggle("inactive"),document.querySelector(".wunderbyte_table_container_"+idstring).classList.toggle("inactivefilter")}))}(idstring);else{var observer=new MutationObserver((function(){isHidden(element)||(this.disconnect(),callback(idstring,encodedtable))})),hiddenElement=returnHiddenElement(element);null!==hiddenElement?observer.observe(hiddenElement,{attributes:!0}):callback(idstring,encodedtable)}}(idstring,encodedtable,callLoadData))};function getScrollParent(node){return null===node?null:node.scrollHeight>node.clientHeight?node:getScrollParent(node.parentNode)}var isHidden=function(el){var style=window.getComputedStyle(el);return"none"===style.display||"hidden"===style.visibility};_exports.isHidden=isHidden;var callLoadData=function callLoadData(idstring,encodedtable){var page=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,tsort=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,thide=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,tshow=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,tdir=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,treset=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,filterobjects=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,searchtext=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,replacerow=arguments.length>10&&void 0!==arguments[10]&&arguments[10];if(!loadings[idstring]||replacerow){null!==page&&(infinitescrollEnabled(idstring)?scrollpages[idstring]=page:scrollpages[idstring]=-1),null===filterobjects&&(filterobjects=(0,_filter.getFilterObjects)(idstring)),null===searchtext&&(searchtext=(0,_search.getSearchInput)(idstring)),null===tsort&&(tsort=(0,_sort.getSortSelection)(idstring)),!0!==moreThanOneTable&&(0,_filter2.updateUrlWithFilterSearchSort)(filterobjects,searchtext,tsort,tdir);var _done,table=document.getElementById("a"+idstring),spinner=document.querySelector("#a"+idstring+"spinner .spinner-border");0!=scrollpages[idstring]||replacerow||spinner&&spinner.classList.remove("hidden"),checkInTable(idstring,encodedtable,page,tsort,thide,tshow,tdir,treset,filterobjects,searchtext,replacerow),loadings[idstring]=!0,_ajax.default.call([{methodname:"local_wunderbyte_table_load_data",args:{encodedtable:encodedtable,page:page,tsort:tsort,thide:thide,tshow:tshow,tdir:tdir,treset:treset,wbtfilter:filterobjects,searchtext:searchtext},done:(_done=_asyncToGenerator(regeneratorRuntime.mark((function _callee(res){var jsonobject,rendertemplate,container,componentscontainer,rowtemplate,_rows,_promises,promise,promises,frag,rows;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(jsonobject=JSON.parse(res.content),rendertemplate=res.template,container=document.querySelector(".wunderbyte_table_container_"+idstring),componentscontainer=container.querySelector(".wunderbyte_table_components"),!(replacerow||scrollpages[idstring]>0)){_context.next=15;break}if(rowtemplate=rendertemplate+"_row",jsonobject.table.hasOwnProperty("rows")){_context.next=10;break}return scrollpages[idstring]=-1,loadings[idstring]=!1,_context.abrupt("return");case 10:return _rows=jsonobject.table.rows,_promises=_rows.map((function(row){return _templates.default.renderForPromise(rowtemplate,row).then((function(_ref){var html=_ref.html,js=_ref.js;if(replacerow){var rowid=JSON.parse(filterobjects).id;_templates.default.replaceNode("#a"+idstring+" .rows-container tr[data-id='"+rowid+"']",html,js)}else _templates.default.appendNodeContents("#a"+idstring+" .rows-container",html,js);return!0})).catch((function(e){console.log(e)})),!0})),tablejss.hasOwnProperty(idstring)||(promise=returnPromiseToSaveJS(rendertemplate,jsonobject,idstring),_promises.push(promise)),Promise.all(_promises).then((function(){setTimeout((function(){_templates.default.appendNodeContents("#a"+idstring,"",tablejss[idstring])}),100),loadings[idstring]=!1})).catch((function(e){console.log(e)})),_context.abrupt("return");case 15:return promises=[],componentscontainer?promises.push(_templates.default.renderForPromise("local_wunderbyte_table/component_sort",jsonobject).then((function(_ref2){var html=_ref2.html,js=_ref2.js,element=container.querySelector(".wunderbyteTableSelect");return _templates.default.replaceNode(element,html,js),!0})).catch((function(ex){console.log(ex)}))):rendertemplate+="_container",frag=container.querySelector(".wunderbyteTableClass"),rows=jsonobject.table.rows,tsort&&(!rows||rows.length<1)?(spinner&&spinner.classList.add("hidden"),table&&table.classList.remove("hidden"),loadings[idstring]=!1):promises.push(_templates.default.renderForPromise(rendertemplate,jsonobject).then((function(_ref3){var html=_ref3.html,js=_ref3.js;if(componentscontainer){for(;frag.firstChild;)frag.removeChild(frag.lastChild);_templates.default.appendNodeContents("#a"+idstring,html,js)}else{var parent=container.parentElement;container.remove(),_templates.default.appendNodeContents(parent,html,js),container=document.querySelector(".wunderbyte_table_container_"+idstring)}addLinksToPagination(idstring,encodedtable,container),loadings[idstring]=!1,spinner&&spinner.classList.add("hidden"),table&&table.classList.remove("hidden"),initializeComponents(idstring,encodedtable);var element=container.querySelector("#a"+idstring);return addScrollFunctionality(idstring,encodedtable,element),!0})).catch((function(ex){loadings[idstring]=!1,_notification.default.addNotification({message:"failed rendering "+ex,type:"danger"})}))),_context.next=22,promises[0];case 22:return _context.sent,_context.next=25,promises[1];case 25:_context.sent;case 26:case"end":return _context.stop()}}),_callee)}))),function(_x){return _done.apply(this,arguments)}),fail:function(err){if(1!=treset)callLoadData(idstring,encodedtable,page,null,null,null,null,1);else{var node=document.createElement("DIV"),textnode=document.createTextNode(err.message);node.appendChild(textnode),table.appendChild(node),spinner.classList.add("hidden"),table.classList.remove("hidden")}}}])}};function addScrollFunctionality(idstring,encodedtable,element){if(infinitescrollEnabled(idstring)&&!element.dataset.scrollinitialized){element.dataset.scrollinitialized=!0;var scrollableelement=getScrollParent(element);scrollableelement&&(scrollableelement.addEventListener("scroll",(function(){scrollingelement.hasOwnProperty(idstring)?"scrollElement"===scrollingelement[idstring]&&scrollListener(element,idstring,encodedtable):scrollingelement[idstring]="scrollElement"})),window.addEventListener("scroll",(function(){scrollingelement.hasOwnProperty(idstring)?"window"===scrollingelement[idstring]&&scrollListener(element,idstring,encodedtable):scrollingelement[idstring]="window"})))}}function scrollListener(element,idstring,encodedtable){if(!returnHiddenElement(element)){var elementtop=element.getBoundingClientRect().top,elementheight=element.getBoundingClientRect().height,screenheight=document.body.scrollHeight;!loadings[idstring]&&scrollpages[idstring]>=0&&elementtop+elementheight-screenheight<0&&(scrollpages[idstring]=scrollpages[idstring]+1,callLoadData(idstring,encodedtable,scrollpages[idstring],null,null,null,null,null,null,null))}}function returnHiddenElement(element){for(;null!==element;){if(isHidden(element))return element;element=element.parentElement}return null}function addLinksToPagination(idstring,encodedtable,frag){var arrayOfPageItems=frag.querySelectorAll(".page-item");arrayOfPageItems&&0!=arrayOfPageItems.length&&arrayOfPageItems.forEach((function(item){var pageNumber=item.dataset.pagenumber;pageNumber&&(--pageNumber,item.addEventListener("click",(function(){callLoadData(idstring,encodedtable,pageNumber)})))}))}function infinitescrollEnabled(idstring){var selector=".wunderbyte_table_container_"+idstring;return!!document.querySelector(selector+" div.infinitescroll_enabled")}function initializeComponents(idstring,encodedtable){var selector=".wunderbyte_table_container_"+idstring;(0,_filter.initializeCheckboxes)(selector,idstring,encodedtable),(0,_search.initializeSearch)(selector,idstring,encodedtable),(0,_sort.initializeSort)(selector,idstring,encodedtable),(0,_rowsdisplayselect.initializeRowsSelect)(selector,idstring,encodedtable),_reload.initializeReload&&(0,_reload.initializeReload)(selector,idstring,encodedtable),(0,_actionbutton.initializeActionButton)(selector,idstring,encodedtable)}function returnPromiseToSaveJS(rendertemplate,jsonobject,idstring){return _templates.default.renderForPromise(rendertemplate,jsonobject).then((function(_ref4){_ref4.html;var js=_ref4.js;return tablejss[idstring]=js,!0})).catch((function(e){console.log(e)}))}function checkInTable(idstring,encodedtable){var page=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,tsort=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,thide=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,tshow=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,tdir=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,treset=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,filterobjects=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,searchtext=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,replacerow=arguments.length>10&&void 0!==arguments[10]&&arguments[10];replacerow||(queries[idstring]={idstring:idstring,encodedtable:encodedtable,page:page,tsort:tsort,thide:thide,tshow:tshow,tdir:tdir,treset:treset,filterobjects:filterobjects,searchtext:searchtext,replacerow:!1})}_exports.callLoadData=callLoadData}));

//# sourceMappingURL=init.min.js.map