define("local_wunderbyte_table/init",["exports","core/ajax","core/templates","core/notification","local_wunderbyte_table/search"],(function(_exports,_ajax,_templates,_notification,_search){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * @package    local_wunderbyte_table
   * @copyright  Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.isHidden=_exports.init=_exports.callLoadData=void 0,_exports.wbTableReload=function(idstring){let encodedtable=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;idstring=idstring.substring(1);let element=document.getElementById("a"+idstring);if(!element)return;if(!encodedtable&&(encodedtable=element.dataset.encodedtable,!encodedtable))return;callLoadData(idstring,encodedtable)},_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);var loading=!1,scrollpage=0,tablejs=null;_exports.init=(idstring,encodedtable)=>{idstring&&encodedtable&&function(idstring,encodedtable,callback){const identifier="a"+idstring;let element=document.getElementById(identifier);if(!element||element.dataset.encodedtable)return;element.dataset.encodedtable=encodedtable;let spinner=document.getElementById(identifier+"spinner");if(null===spinner||isHidden(spinner)){replaceLinksInFrag(idstring,encodedtable,element,null);const selector=".wunderbyte_table_container_"+idstring;(0,_search.initializeCheckboxes)(selector,idstring,encodedtable)}else{callback(idstring,encodedtable);for(var observer=new MutationObserver((function(){isHidden(element)||(this.disconnect(),callback(idstring,encodedtable))}));null!==element;){if(isHidden(element))return void observer.observe(element,{attributes:!0});element=element.parentElement}}if(element.dataset.scrollinitialized)return;element.dataset.scrollinitialized=!0,console.log("initialize scroll",element.dataset.scrollinitialized);const scrollableelement=document.querySelector("#page");console.log(scrollableelement),scrollableelement.addEventListener("scroll",(()=>{console.log("load more data",element.scrollHeight,scrollableelement.scrollTop,document.body.scrollHeight,scrollableelement.scrollTop+document.body.scrollHeight),!loading&&scrollpage>=0&&element.scrollHeight<scrollableelement.scrollTop+document.body.scrollHeight&&(console.log("load more data",window.scrollY,window.scrollY+window.innerHeight,document.body.scrollHeight),scrollpage++,console.log("call load for scroll",scrollpage),callLoadData(idstring,encodedtable,scrollpage,null,null,null,null,null,null,null))}))}(idstring,encodedtable,callLoadData)};const isHidden=el=>{var style=window.getComputedStyle(el);return"none"===style.display||"hidden"===style.visibility};_exports.isHidden=isHidden;const callLoadData=function(idstring,encodedtable){let page=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,tsort=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,thide=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,tshow=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,tdir=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,treset=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,filterobjects=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,searchtext=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null;if(loading)return;null!==page&&(scrollpage=page),null===filterobjects&&(filterobjects=(0,_search.getFilterOjects)());let table=document.getElementById("a"+idstring),spinner=document.querySelector("#a"+idstring+"spinner .spinner-border");console.log(table),0==scrollpage&&(spinner&&spinner.classList.remove("hidden"),table&&table.classList.add("hidden")),loading=!0,_ajax.default.call([{methodname:"local_wunderbyte_table_load_data",args:{encodedtable:encodedtable,page:page,tsort:tsort,thide:thide,tshow:tshow,tdir:tdir,treset:treset,filterobjects:filterobjects,searchtext:searchtext},done:function(res){console.log(res);let jsonobject=JSON.parse(res.content),rendertemplate=res.template,rendercontainer=!0,container=document.querySelector(".wunderbyte_table_container_"+idstring);const filtercontainer=container.querySelector(".wunderbyteTableFilter");if(scrollpage>0){const i=rendertemplate.lastIndexOf("/");let rowtemplate=rendertemplate.substring(0,i);if(rowtemplate+="/row",console.log(rowtemplate,rendertemplate),!jsonobject.table.hasOwnProperty("rows"))return scrollpage=-1,void(loading=!1);let rows=jsonobject.table.rows;console.log(rendertemplate,rows);const promises=rows.map((row=>{_templates.default.renderForPromise(rowtemplate,row).then((_ref=>{let{html:html,js:js}=_ref;return _templates.default.appendNodeContents("#a"+idstring+" div.rows",html,js),!0})).catch((e=>{console.log(e)}))}));if(null===tablejs){const promise=_templates.default.renderForPromise(rendertemplate,jsonobject).then((_ref2=>{let{html:html,js:js}=_ref2;return tablejs=js,!0})).catch((e=>{console.log(e)}));promises.push(promise)}return void Promise.all(promises).then((()=>{console.log(promises.length),setTimeout((()=>{_templates.default.appendNodeContents("#a"+idstring,"",tablejs),console.log("just added js to page "+page+" "+rows)}),100),loading=!1})).catch((e=>{console.log(e)}))}if(filtercontainer){const i=rendertemplate.lastIndexOf("/");rendertemplate=rendertemplate.substring(0,i),rendertemplate+="/table",rendercontainer=!1}let frag=container.querySelector(".wunderbyteTableClass");_templates.default.renderForPromise(rendertemplate,jsonobject).then((_ref3=>{let{html:html,js:js}=_ref3;if(rendercontainer){const parent=container.parentElement;container.remove(),_templates.default.appendNodeContents(parent,html,js),container=document.querySelector(".wunderbyte_table_container_"+idstring)}else{for(;frag.firstChild;)frag.removeChild(frag.lastChild);_templates.default.appendNodeContents("#a"+idstring,html,js)}return replaceLinksInFrag(idstring,encodedtable,container,page),loading=!1,spinner&&spinner.classList.add("hidden"),table&&table.classList.remove("hidden"),!0})).catch((ex=>{loading=!1,_notification.default.addNotification({message:"failed rendering "+ex,type:"danger"})}))},fail:function(err){if(1!=treset)callLoadData(idstring,encodedtable,page,null,null,null,null,1);else{let node=document.createElement("DIV"),textnode=document.createTextNode(err.message);node.appendChild(textnode),table.appendChild(node),spinner.classList.add("hidden"),table.classList.remove("hidden")}}}])};function replaceSortColumnLinks(idstring,encodedtable,frag,page){frag.querySelectorAll("th.header a").forEach((item=>{var sortid=item.getAttribute("data-sortby"),sortorder=item.getAttribute("data-sortorder"),thide="hide"==item.getAttribute("data-action")?item.getAttribute("data-column"):null,tshow="show"==item.getAttribute("data-action")?item.getAttribute("data-column"):null;item.setAttribute("href","#"),item.addEventListener("click",(()=>{callLoadData(idstring,encodedtable,page,sortid,thide,tshow,sortorder)}))}))}function replaceResetTableLink(idstring,encodedtable,frag,page){var arrayOfItems=frag.querySelectorAll("div.resettable");arrayOfItems&&0!=arrayOfItems.length&&arrayOfItems.forEach((item=>{if(item.getAttribute("class").indexOf("resettable")>=0){item.querySelectorAll("a").forEach((subitem=>{subitem.setAttribute("href","#"),subitem.addEventListener("click",(()=>{callLoadData(idstring,encodedtable,page,null,null,null,null,1)}))}))}}))}function replacePaginationLinks(idstring,encodedtable,frag){var arrayOfPageItems=frag.querySelectorAll(".page-item");arrayOfPageItems&&0!=arrayOfPageItems.length&&arrayOfPageItems.forEach((item=>{let pageNumber=item.dataset.pagenumber;pageNumber&&(--pageNumber,item.addEventListener("click",(()=>{callLoadData(idstring,encodedtable,pageNumber)})))}))}function replaceDownloadLink(idstring,encodedtable,frag){frag.querySelectorAll("form").forEach((item=>{if("FORM"==item.tagName){item.setAttribute("method","POST");let newnode=document.createElement("input");newnode.setAttribute("type","hidden"),newnode.setAttribute("name","encodedtable"),newnode.setAttribute("value",encodedtable),item.appendChild(newnode)}}))}function replaceLinksInFrag(idstring,encodedtable,frag){let page=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(!page){const activepage=frag.querySelector("li.page-item active");activepage&&(page=activepage.getAttribute("data-page-number"))}replaceDownloadLink(0,encodedtable,frag),replaceResetTableLink(idstring,encodedtable,frag,page),replacePaginationLinks(idstring,encodedtable,frag),replaceSortColumnLinks(idstring,encodedtable,frag,page)}_exports.callLoadData=callLoadData}));

//# sourceMappingURL=init.min.js.map