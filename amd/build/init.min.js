define("local_wunderbyte_table/init",["exports","core/ajax","core/templates","core/notification","local_wunderbyte_table/filter","local_wunderbyte_table/search","local_wunderbyte_table/sort","local_wunderbyte_table/reload"],(function(_exports,_ajax,_templates,_notification,_filter,_search,_sort,_reload){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * @package    local_wunderbyte_table
   * @copyright Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.isHidden=_exports.init=_exports.callLoadData=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);var loadings={},scrollpages={},tablejss={},scrollingelement={};_exports.init=(idstring,encodedtable)=>{console.log("wb init",idstring),idstring&&encodedtable&&(scrollpages.hasOwnProperty(idstring)||(infinitescrollEnabled(idstring)?scrollpages[idstring]=0:scrollpages[idstring]=-1),function(idstring,encodedtable,callback){const identifier="a"+idstring;let element=document.querySelector("#"+identifier);if(!element||element.dataset.encodedtable)return void console.log("wb didnnt find element aborted",identifier);element.dataset.encodedtable=encodedtable;let spinner=document.querySelector("#"+identifier+"spinner");if(null===spinner||isHidden(spinner)){replaceLinksInFrag(idstring,encodedtable,element,null);const selector=".wunderbyte_table_container_"+idstring;(0,_filter.initializeCheckboxes)(selector,idstring,encodedtable),(0,_search.initializeSearch)(selector,idstring,encodedtable),(0,_sort.initializeSort)(selector,idstring,encodedtable),(0,_reload.initializeReload)(selector,idstring,encodedtable),addScrollFunctionality(idstring,encodedtable,element),(idstring=>{const togglebutton=document.querySelector("#asidecollapse_"+idstring);togglebutton&&togglebutton.addEventListener("click",(()=>{document.querySelector(".wunderbyte_table_container_"+idstring+" aside").classList.toggle("inactive")}))})(idstring)}else{var observer=new MutationObserver((function(){isHidden(element)||(this.disconnect(),callback(idstring,encodedtable))}));const hiddenElement=returnHiddenElement(element);null!==hiddenElement?observer.observe(hiddenElement,{attributes:!0}):callback(idstring,encodedtable)}}(idstring,encodedtable,callLoadData))};function getScrollParent(node){return null===node?null:node.scrollHeight>node.clientHeight?node:getScrollParent(node.parentNode)}const isHidden=el=>{var style=window.getComputedStyle(el);return"none"===style.display||"hidden"===style.visibility};_exports.isHidden=isHidden;const callLoadData=function(idstring,encodedtable){let page=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,tsort=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,thide=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,tshow=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,tdir=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,treset=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,filterobjects=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,searchtext=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,replacerow=arguments.length>10&&void 0!==arguments[10]&&arguments[10];if(loadings[idstring])return;null!==page&&(infinitescrollEnabled(idstring)?scrollpages[idstring]=page:scrollpages[idstring]=-1),null===filterobjects&&(filterobjects=(0,_filter.getFilterOjects)(idstring)),null===searchtext&&(searchtext=(0,_search.getSearchInput)(idstring)),null===tsort&&(tsort=(0,_sort.getSortSelection)(idstring));let table=document.getElementById("a"+idstring),spinner=document.querySelector("#a"+idstring+"spinner .spinner-border");0!=scrollpages[idstring]||replacerow||spinner&&spinner.classList.remove("hidden"),loadings[idstring]=!0,_ajax.default.call([{methodname:"local_wunderbyte_table_load_data",args:{encodedtable:encodedtable,page:page,tsort:tsort,thide:thide,tshow:tshow,tdir:tdir,treset:treset,filterobjects:filterobjects,searchtext:searchtext},done:function(res){let jsonobject=JSON.parse(res.content),rendertemplate=res.template,container=document.querySelector(".wunderbyte_table_container_"+idstring);const componentscontainer=container.querySelector(".wunderbyte_table_components");if(replacerow||scrollpages[idstring]>0){const rowtemplate=rendertemplate+"_row";if(!jsonobject.table.hasOwnProperty("rows"))return scrollpages[idstring]=-1,void(loadings[idstring]=!1);const promises=jsonobject.table.rows.map((row=>(_templates.default.renderForPromise(rowtemplate,row).then((_ref=>{let{html:html,js:js}=_ref;if(replacerow){const rowid=JSON.parse(filterobjects).id;_templates.default.replaceNode("#a"+idstring+" .rows-container tr[data-id='"+rowid+"']",html,js)}else _templates.default.appendNodeContents("#a"+idstring+" .rows-container",html,js);return!0})).catch((e=>{console.log(e)})),!0)));if(!tablejss.hasOwnProperty(idstring)){const promise=_templates.default.renderForPromise(rendertemplate,jsonobject).then((_ref2=>{let{html:html,js:js}=_ref2;return tablejss[idstring]=js,!0})).catch((e=>{console.log(e)}));promises.push(promise)}return void Promise.all(promises).then((()=>{setTimeout((()=>{_templates.default.appendNodeContents("#a"+idstring,"",tablejss[idstring])}),100),loadings[idstring]=!1})).catch((e=>{console.log(e)}))}componentscontainer||(rendertemplate+="_container");let frag=container.querySelector(".wunderbyteTableClass");tsort&&"table"in jsonobject&&"header"in jsonobject.table&&"headers"in jsonobject.table.header&&jsonobject.table.header.headers.forEach((item=>{item.key==tsort?item.sortclass=4==tdir?"desc":"asc":delete item.sortclass}));let rows=jsonobject.table.rows;tsort&&(!rows||rows.length<1)?(spinner&&spinner.classList.add("hidden"),table&&table.classList.remove("hidden"),loadings[idstring]=!1):_templates.default.renderForPromise(rendertemplate,jsonobject).then((_ref3=>{let{html:html,js:js}=_ref3;if(componentscontainer){for(;frag.firstChild;)frag.removeChild(frag.lastChild);_templates.default.appendNodeContents("#a"+idstring,html,js)}else{const parent=container.parentElement;container.remove(),_templates.default.appendNodeContents(parent,html,js),container=document.querySelector(".wunderbyte_table_container_"+idstring)}replaceLinksInFrag(idstring,encodedtable,container,page),loadings[idstring]=!1,spinner&&spinner.classList.add("hidden"),table&&table.classList.remove("hidden");const selector=".wunderbyte_table_container_"+idstring;(0,_filter.initializeCheckboxes)(selector,idstring,encodedtable),(0,_search.initializeSearch)(selector,idstring,encodedtable),(0,_sort.initializeSort)(selector,idstring,encodedtable);const element=container.querySelector("#a"+idstring);return addScrollFunctionality(idstring,encodedtable,element),!0})).catch((ex=>{loadings[idstring]=!1,_notification.default.addNotification({message:"failed rendering "+ex,type:"danger"})}))},fail:function(err){if(1!=treset)callLoadData(idstring,encodedtable,page,null,null,null,null,1);else{let node=document.createElement("DIV"),textnode=document.createTextNode(err.message);node.appendChild(textnode),table.appendChild(node),spinner.classList.add("hidden"),table.classList.remove("hidden")}}}])};function addScrollFunctionality(idstring,encodedtable,element){if(!infinitescrollEnabled(idstring))return;if(element.dataset.scrollinitialized)return;element.dataset.scrollinitialized=!0;const scrollableelement=getScrollParent(element);console.log(scrollableelement),scrollableelement&&(scrollableelement.addEventListener("scroll",(()=>{scrollingelement.hasOwnProperty(idstring)?"scrollElement"===scrollingelement[idstring]&&scrollListener(element,idstring,encodedtable):scrollingelement[idstring]="scrollElement"})),window.addEventListener("scroll",(()=>{scrollingelement.hasOwnProperty(idstring)?"window"===scrollingelement[idstring]&&scrollListener(element,idstring,encodedtable):scrollingelement[idstring]="window"})))}function scrollListener(element,idstring,encodedtable){if(returnHiddenElement(element))return;const elementtop=element.getBoundingClientRect().top,elementheight=element.getBoundingClientRect().height,screenheight=document.body.scrollHeight;!loadings[idstring]&&scrollpages[idstring]>=0&&elementtop+elementheight-screenheight<0&&(scrollpages[idstring]=scrollpages[idstring]+1,callLoadData(idstring,encodedtable,scrollpages[idstring],null,null,null,null,null,null,null))}function returnHiddenElement(element){for(;null!==element;){if(isHidden(element))return element;element=element.parentElement}return null}function replaceSortColumnLinks(idstring,encodedtable,frag,page){frag.querySelectorAll("th.header a").forEach((item=>{var sortid=item.getAttribute("data-sortby"),sortorder=item.getAttribute("data-sortorder"),thide="hide"==item.getAttribute("data-action")?item.getAttribute("data-column"):null,tshow="show"==item.getAttribute("data-action")?item.getAttribute("data-column"):null;item.setAttribute("href","#"),item.addEventListener("click",(()=>{callLoadData(idstring,encodedtable,page,sortid,thide,tshow,sortorder)}))}))}function replaceResetTableLink(idstring,encodedtable,frag,page){var arrayOfItems=frag.querySelectorAll("div.resettable");arrayOfItems&&0!=arrayOfItems.length&&arrayOfItems.forEach((item=>{if(item.getAttribute("class").indexOf("resettable")>=0){item.querySelectorAll("a").forEach((subitem=>{subitem.setAttribute("href","#"),subitem.addEventListener("click",(()=>{callLoadData(idstring,encodedtable,page,null,null,null,null,1)}))}))}}))}function replacePaginationLinks(idstring,encodedtable,frag){var arrayOfPageItems=frag.querySelectorAll(".page-item");arrayOfPageItems&&0!=arrayOfPageItems.length&&arrayOfPageItems.forEach((item=>{let pageNumber=item.dataset.pagenumber;pageNumber&&(--pageNumber,item.addEventListener("click",(()=>{callLoadData(idstring,encodedtable,pageNumber)})))}))}function replaceDownloadLink(idstring,encodedtable,frag){frag.querySelectorAll("form").forEach((item=>{if("FORM"==item.tagName){item.setAttribute("method","POST");let newnode=document.createElement("input");newnode.setAttribute("type","hidden"),newnode.setAttribute("name","encodedtable"),newnode.setAttribute("value",encodedtable),item.appendChild(newnode)}}))}function replaceLinksInFrag(idstring,encodedtable,frag){let page=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(!page){const activepage=frag.querySelector("li.page-item active");activepage&&(page=activepage.getAttribute("data-page-number"))}replaceDownloadLink(0,encodedtable,frag),replaceResetTableLink(idstring,encodedtable,frag,page),replacePaginationLinks(idstring,encodedtable,frag),replaceSortColumnLinks(idstring,encodedtable,frag,page)}function infinitescrollEnabled(idstring){const selector=".wunderbyte_table_container_"+idstring;return!!document.querySelector(selector+" div.infinitescroll_enabled")}_exports.callLoadData=callLoadData}));

//# sourceMappingURL=init.min.js.map