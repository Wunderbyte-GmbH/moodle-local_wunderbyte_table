{"version":3,"sources":["../src/init.js"],"names":["init","idstring","encodedtable","respondToVisibility","callLoadData","callback","element","document","getElementById","observer","MutationObserver","isHidden","disconnect","parentElement","observe","attributes","el","style","window","getComputedStyle","display","visibility","page","tsort","thide","tshow","tdir","treset","table","spinner","querySelector","classList","toggle","Ajax","call","methodname","args","done","res","frag","createRange","createContextualFragment","content","activepage","getAttribute","replaceDownloadLink","replaceResetTableLink","replacePaginationLinks","replaceSortColumnLinks","firstChild","removeChild","lastChild","appendChild","allElements","getElementsByClassName","i","spanchild","length","onclick","click","add","remove","fail","err","node","createElement","textnode","createTextNode","message","arrayOfItems","querySelectorAll","forEach","item","sortid","sortorder","setAttribute","addEventListener","classofelement","indexOf","listOfChildren","subitem","arrayOfPageItems","pageNumber","dataset","pagenumber","tagName","newnode"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @package    local_wunderbyte_table\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\n\n/**\n * Gets called from mustache template.\n * @param {string} idstring\n * @param {string} encodedtable\n */\nexport const init = (idstring, encodedtable) => {\n    respondToVisibility(idstring, encodedtable, callLoadData);\n};\n\n/**\n * React on visibility change.\n * @param {string} idstring\n * @param {string} encodedtable\n * @param {function} callback\n */\nfunction respondToVisibility(idstring, encodedtable, callback) {\n    let element = document.getElementById('a' + idstring);\n    var observer = new MutationObserver(function() {\n        if (!isHidden(element)) {\n            this.disconnect();\n            callback(idstring, encodedtable);\n        }\n    });\n\n    // We look if we find a hidden parent. If not, we load right away.\n    while (element !== null) {\n        if (!isHidden(element)) {\n            element = element.parentElement;\n        } else {\n            observer.observe(element, {attributes: true});\n            return;\n        }\n    }\n    callback(idstring, encodedtable);\n}\n\n/**\n * Function to check visibility of element.\n * @param {*} el\n * @returns {boolean}\n */\nfunction isHidden(el) {\n    var style = window.getComputedStyle(el);\n    return ((style.display === 'none') || (style.visibility === 'hidden'));\n}\n\n/**\n * Reloads the rendered table and sets it to the div with the right identifier.\n * @param {string} idstring\n * @param {string} encodedtable\n * @param {null|int} page\n * @param {null|string} tsort\n * @param {null|string} thide\n * @param {null|string} tshow\n * @param {null|int} tdir\n * @param {null|int} treset\n */\nexport const callLoadData = (\n    idstring,\n    encodedtable,\n    page = null,\n    tsort = null,\n    thide = null,\n    tshow = null,\n    tdir = null,\n    treset = null) => {\n    let table = document.getElementById('a' + idstring);\n    let spinner = document.querySelector('#a' + idstring + 'spinner .spinner-border');\n    spinner.classList.toggle('hidden');\n    table.classList.toggle('hidden');\n\n    Ajax.call([{\n        methodname: \"local_wunderbyte_table_load_data\",\n        args: {\n            'encodedtable': encodedtable,\n            'page': page,\n            'tsort': tsort,\n            'thide': thide,\n            'tshow': tshow,\n            'tdir': tdir,\n            'treset': treset\n        },\n        done: function(res) {\n\n            let frag = document.createRange().createContextualFragment(res.content);\n\n            if (!page) {\n                const activepage = frag.querySelector('li.page-item active');\n                if (activepage) {\n                    page = activepage.getAttribute('data-page-number');\n                }\n            }\n\n            replaceDownloadLink(idstring, encodedtable, frag);\n            replaceResetTableLink(idstring, encodedtable, frag, page);\n            replacePaginationLinks(idstring, encodedtable, frag);\n            replaceSortColumnLinks(idstring, encodedtable, frag, page);\n\n            let table = document.getElementById('a' + idstring);\n\n            while (table.firstChild) {\n                table.removeChild(table.lastChild);\n            }\n            table.appendChild(frag);\n            // Once the frag is appended, we have to trigger all load Events.\n            const allElements = table.getElementsByClassName('wunderbyteTableDiv');\n            for (var i = 0; i < allElements.length; i++) {\n                const spanchild = allElements[i].querySelector('span');\n                if (typeof spanchild.onclick === 'function') {\n                    spanchild.click();\n                }\n             }\n\n            spinner.classList.add('hidden');\n            table.classList.remove('hidden');\n            return true;\n        },\n        fail: function(err) {\n            // If we have an error, resetting the table might be enough. we do that.\n            // To avoid a loop, we only do this in special cases.\n            if ((treset != 1)) {\n                callLoadData(idstring, encodedtable, page, null, null, null, null, 1);\n            } else {\n                let node = document.createElement('DIV');\n                let textnode = document.createTextNode(err.message);\n                node.appendChild(textnode);\n                table.appendChild(node);\n                spinner.classList.add('hidden');\n                table.classList.remove('hidden');\n            }\n        }\n    }]);\n};\n\n/**\n * The rendered table has links we can't use. We replace them with eventlisteners and use the callLoadData function.\n * @param {string} idstring\n * @param {string} encodedtable\n * @param {DocumentFragment} frag\n * @param {int} page\n */\nfunction replaceSortColumnLinks(idstring, encodedtable, frag, page) {\n\n    var arrayOfItems = frag.querySelectorAll(\"th.header a\");\n\n    arrayOfItems.forEach(item => {\n        var sortid = item.getAttribute('data-sortby');\n        var sortorder = item.getAttribute('data-sortorder');\n        var thide = item.getAttribute('data-action') == 'hide' ? item.getAttribute('data-column') : null;\n        var tshow = item.getAttribute('data-action') == 'show' ? item.getAttribute('data-column') : null;\n\n        item.setAttribute('href', '#');\n        item.addEventListener('click', () => {\n            callLoadData(idstring, encodedtable, page, sortid, thide, tshow, sortorder);\n        });\n    });\n}\n\n/**\n * The rendered table has links we can't use. We replace them with eventlisteners and use the callLoadData function.\n * @param {string} idstring\n * @param {string} encodedtable\n * @param {DocumentFragment} frag\n * @param {int} page\n */\nfunction replaceResetTableLink(idstring, encodedtable, frag, page) {\n    var arrayOfItems = frag.querySelectorAll(\"div.resettable\");\n\n    if (!arrayOfItems || arrayOfItems.length == 0) {\n        return;\n    }\n    arrayOfItems.forEach(item => {\n        var classofelement = item.getAttribute('class');\n        if (classofelement.indexOf('resettable') >= 0) {\n            let listOfChildren = item.querySelectorAll('a');\n            listOfChildren.forEach(subitem => {\n                subitem.setAttribute('href', '#');\n                subitem.addEventListener('click', () => {\n                    callLoadData(idstring, encodedtable, page, null, null, null, null, 1);\n                });\n            });\n        }\n    });\n}\n\n/**\n * The rendered table has links we can't use. We replace them with eventlisteners and use the callLoadData function.\n * @param {string} idstring\n * @param {string} encodedtable\n * @param {DocumentFragment} frag\n */\nfunction replacePaginationLinks(idstring, encodedtable, frag) {\n    var arrayOfPageItems = frag.querySelectorAll(\".page-item\");\n\n    if (!arrayOfPageItems || arrayOfPageItems.length == 0) {\n        return;\n    }\n    arrayOfPageItems.forEach(item => {\n\n        let pageNumber = item.dataset.pagenumber;\n\n        if (pageNumber) {\n            --pageNumber;\n            item.addEventListener('click', () => {\n                callLoadData(idstring, encodedtable, pageNumber);\n            });\n        }\n    });\n}\n\n/**\n * The rendered table has links we can't use. We replace them with eventlisteners and use the callLoadData function.\n * @param {string} idstring\n * @param {string} encodedtable\n * @param {DocumentFragment} frag\n */\nfunction replaceDownloadLink(idstring, encodedtable, frag) {\n\n    var arrayOfItems = frag.querySelectorAll(\"form\");\n\n    arrayOfItems.forEach(item => {\n        if (item.tagName == 'FORM') {\n            item.setAttribute('method', 'POST');\n            let newnode = document.createElement('input');\n            newnode.setAttribute('type', 'hidden');\n            newnode.setAttribute('name', 'encodedtable');\n            newnode.setAttribute('value', encodedtable);\n            item.appendChild(newnode);\n        }\n    });\n}"],"file":"init.min.js"}