{"version":3,"sources":["../src/init.js"],"names":["init","idstring","callLoadData","page","tsort","thide","tshow","tdir","treset","table","document","getElementById","spinner","querySelector","classList","toggle","encodedtable","getAttribute","Ajax","call","methodname","args","done","res","frag","createRange","createContextualFragment","content","activepage","replaceDownloadLink","replaceResetTableLink","replacePaginationLinks","replaceSortColumnLinks","firstChild","removeChild","lastChild","appendChild","add","remove","fail","err","node","createElement","textnode","createTextNode","message","arrayOfItems","querySelectorAll","forEach","item","sortid","sortorder","setAttribute","addEventListener","length","classofelement","indexOf","listOfChildren","subitem","arrayOfPageItems","element","url","pageNumber","newurl","URL","urlParams","URLSearchParams","search","get","tagName","newnode"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @package    local_wunderbyte_table\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\n\n/**\n * Gets called from mustache template.\n * @param {string} idstring\n */\nexport const init = (idstring) => {\n    callLoadData(idstring);\n};\n\n/**\n * Reloads the rendered table and sets it to the div with the right identifier.\n * @param {string} idstring\n * @param {null|int} page\n * @param {null|string} tsort\n * @param {null|string} thide\n * @param {null|string} tshow\n * @param {null|int} tdir\n * @param {null|int} treset\n */\nexport const callLoadData = (\n    idstring,\n    page = null,\n    tsort = null,\n    thide = null,\n    tshow = null,\n    tdir = null,\n    treset = null) => {\n\n    let table = document.getElementById('a' + idstring);\n    let spinner = document.querySelector('#a' + idstring + 'spinner .spinner-border');\n    spinner.classList.toggle('hidden');\n    table.classList.toggle('hidden');\n\n    let encodedtable = table.getAttribute('data-encodedtable');\n\n    Ajax.call([{\n        methodname: \"local_wunderbyte_table_load_data\",\n        args: {\n            'encodedtable': encodedtable,\n            'page': page,\n            'tsort': tsort,\n            'thide': thide,\n            'tshow': tshow,\n            'tdir': tdir,\n            'treset': treset\n        },\n        done: function(res) {\n\n            let frag = document.createRange().createContextualFragment(res.content);\n\n            if (!page) {\n                const activepage = frag.querySelector('li.page-item active');\n                if (activepage) {\n                    page = activepage.getAttribute('data-page-number');\n                }\n            }\n\n            replaceDownloadLink(idstring, frag);\n            replaceResetTableLink(idstring, frag, page);\n            replacePaginationLinks(idstring, frag);\n            replaceSortColumnLinks(idstring, frag, page);\n\n            let table = document.getElementById('a' + idstring);\n\n            while (table.firstChild) {\n                table.removeChild(table.lastChild);\n            }\n            table.appendChild(frag);\n            spinner.classList.add('hidden');\n            table.classList.remove('hidden');\n            return true;\n        },\n        fail: function(err) {\n            // If we have an error, resetting the table might be enough. we do that.\n            // To avoid a loop, we only do this in special cases.\n            if ((treset != 1)) {\n                callLoadData(idstring, page, null, null, null, null, 1);\n            } else {\n                let node = document.createElement('DIV');\n                let textnode = document.createTextNode(err.message);\n                node.appendChild(textnode);\n                table.appendChild(node);\n                spinner.classList.add('hidden');\n                table.classList.remove('hidden');\n            }\n        }\n    }]);\n};\n\n/**\n * The rendered table has links we can't use. We replace them with eventlisteners and use the callLoadData function.\n * @param {string} idstring\n * @param {DocumentFragment} frag\n * @param {int} page\n */\nexport const replaceSortColumnLinks = (idstring, frag, page) => {\n\n    var arrayOfItems = frag.querySelectorAll(\"th.header a\");\n\n    arrayOfItems.forEach(item => {\n        var sortid = item.getAttribute('data-sortby');\n        var sortorder = item.getAttribute('data-sortorder');\n        var thide = item.getAttribute('data-action') == 'hide' ? item.getAttribute('data-column') : null;\n        var tshow = item.getAttribute('data-action') == 'show' ? item.getAttribute('data-column') : null;\n\n        item.setAttribute('href', '#');\n        item.addEventListener('click', () => {\n            callLoadData(idstring, page, sortid, thide, tshow, sortorder);\n        });\n    });\n};\n\n/**\n * The rendered table has links we can't use. We replace them with eventlisteners and use the callLoadData function.\n * @param {string} idstring\n * @param {DocumentFragment} frag\n * @param {int} page\n */\nexport const replaceResetTableLink = (idstring, frag, page) => {\n    var arrayOfItems = frag.querySelectorAll(\"div.resettable\");\n\n    if (!arrayOfItems || arrayOfItems.length == 0) {\n        return;\n    }\n    arrayOfItems.forEach(item => {\n        var classofelement = item.getAttribute('class');\n        if (classofelement.indexOf('resettable') >= 0) {\n            let listOfChildren = item.querySelectorAll('a');\n            listOfChildren.forEach(subitem => {\n                subitem.setAttribute('href', '#');\n                subitem.addEventListener('click', () => {\n                    callLoadData(idstring, page, null, null, null, null, 1);\n                });\n            });\n        }\n    });\n};\n\n/**\n * The rendered table has links we can't use. We replace them with eventlisteners and use the callLoadData function.\n * @param {string} idstring\n * @param {DocumentFragment} frag\n */\nexport const replacePaginationLinks = (idstring, frag) => {\n    var arrayOfPageItems = frag.querySelectorAll(\".page-item\");\n\n    if (!arrayOfPageItems || arrayOfPageItems.length == 0) {\n        return;\n    }\n    arrayOfPageItems.forEach(item => {\n        var element = item.querySelector('a');\n        if (!element) {\n            return;\n        }\n        var url = element.getAttribute(\"href\");\n        var pageNumber;\n        if (url != undefined && url != '#') {\n            let newurl = new URL(url);\n            var urlParams = new URLSearchParams(newurl.search);\n            pageNumber = urlParams.get('page');\n        }\n        element.setAttribute('href', '#');\n        if (pageNumber) {\n            element.addEventListener('click', () => {\n                callLoadData(idstring, pageNumber);\n            });\n        }\n    });\n};\n\n/**\n * The rendered table has links we can't use. We replace them with eventlisteners and use the callLoadData function.\n * @param {string} idstring\n * @param {DocumentFragment} frag\n */\nexport const replaceDownloadLink = (idstring, frag) => {\n\n    let table = document.getElementById('a' + idstring);\n    let encodedtable = table.getAttribute('data-encodedtable');\n\n    var arrayOfItems = frag.querySelectorAll(\"form\");\n\n    arrayOfItems.forEach(item => {\n        if (item.tagName == 'FORM') {\n            item.setAttribute('method', 'POST');\n            let newnode = document.createElement('input');\n            newnode.setAttribute('type', 'hidden');\n            newnode.setAttribute('name', 'encodedtable');\n            newnode.setAttribute('value', encodedtable);\n            item.appendChild(newnode);\n        }\n    });\n};"],"file":"init.min.js"}