{"version":3,"file":"actionbutton.min.js","sources":["../src/actionbutton.js"],"sourcesContent":["\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @package    local_wunderbyte_table\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Ajax from 'core/ajax';\nimport {showNotification} from 'local_wunderbyte_table/notifications';\nimport {reloadAllTables} from 'local_wunderbyte_table/reload';\nimport {get_strings as getStrings,\n        get_string as getString} from 'core/str';\n\nconst SELECTOR = {\n  ACTIONBUTTON: '.wb_action_button',\n  CHECKBOX: 'input.wb-checkbox',\n};\n\n/**\n * Function to add click listener to acton button.\n * @param {string} selector\n * @param {string} idstring\n * @param {string} encodedtable\n * @returns {void}\n */\n export function initializeActionButton(selector, idstring, encodedtable) {\n\n      const container = document.querySelector(selector);\n      const actionbuttons = container.querySelectorAll(SELECTOR.ACTIONBUTTON);\n\n      actionbuttons.forEach(button => {\n          if (button.dataset.initialized) {\n            return;\n          }\n\n          if (button.dataset.methodname.length === 0) {\n            return;\n          }\n\n          button.dataset.initialized = true;\n\n          button.addEventListener('click', () => {\n\n            if (button.dataset.nomodal && button.dataset.id > 0) {\n\n              transmitAction(button.dataset.id, button.dataset.methodname, JSON.stringify(button.dataset), idstring, encodedtable);\n            } else {\n              showConfirmationModal(button, idstring, encodedtable);\n            }\n          });\n      });\n}\n\n/**\n * Shows generic confirmation modal.\n * @param {*} button\n * @param {string} idstring\n * @param {string} encodedtable\n */\nasync function showConfirmationModal(button, idstring, encodedtable) {\n\n  const id = button.dataset.id;\n  const methodname = button.dataset.methodname;\n  const data = button.dataset; // Get all the data of the clicked button.\n\n  const result = getIds(id, idstring, data);\n\n  var checkedids = result.checkedids;\n  const labelarray = result.labelarray;\n\n  if (checkedids.length < 1) {\n    const message = await getString('nocheckboxchecked', 'local_wunderbyte_table');\n    showNotification(message, \"danger\");\n    return;\n  }\n\n  const datastring = labelarray.join('<br>') ?? '';\n\n  let strings = [\n    {\n      key: button.dataset.titlestring ?? 'generictitle',\n      component: button.dataset.component ?? 'local_wunderbyte_table',\n    },\n    {\n      key: button.dataset.bodystring ?? 'genericbody',\n      component: button.dataset.component ?? 'local_wunderbyte_table',\n      param: {\n        // eslint-disable-next-line block-scoped-var\n        data: datastring,\n      }\n    },\n    {\n      key: button.dataset.submitbuttonstring ?? 'genericsubmit',\n      component: button.dataset.component ?? 'local_wunderbyte_table',\n    },\n  ];\n\n  const localizedstrings = await getStrings(strings);\n\n  ModalFactory.create({type: ModalFactory.types.SAVE_CANCEL}).then(modal => {\n\n    modal.setTitle(localizedstrings[0]);\n        modal.setBody(localizedstrings[1]);\n        modal.setSaveButtonText(localizedstrings[2]);\n        modal.getRoot().on(ModalEvents.save, function() {\n\n            // If there is only one id, we transmit one call.\n            if (id != 0) {\n              transmitAction(id, methodname, JSON.stringify(data), idstring, encodedtable);\n            } else { // Zero means we want single line execution.\n              // eslint-disable-next-line block-scoped-var\n              checkedids.forEach(cid => {\n                transmitAction(cid, methodname, JSON.stringify(data), idstring, encodedtable);\n              });\n            }\n        });\n\n        modal.show();\n        return modal;\n  }).catch(e => {\n      // eslint-disable-next-line no-console\n      console.log(e);\n  });\n}\n\n/**\n * Ajax function to handle action buttons.\n * @param {int} id\n * @param {string} methodname\n * @param {string} datastring\n * @param {string} idstring\n * @param {string} encodedtable\n */\nfunction transmitAction(id, methodname, datastring, idstring, encodedtable) {\n  Ajax.call([{\n    methodname: \"local_wunderbyte_table_execute_action\",\n    args: {\n        'id': parseInt(id),\n        'methodname': methodname,\n        'data': datastring,\n        'encodedtable': encodedtable,\n    },\n    done: function(data) {\n\n        if (data.success == 1) {\n\n          showNotification(data.message, \"success\");\n        } else {\n          showNotification(data.message, \"danger\");\n        }\n        reloadAllTables();\n\n\n    },\n    fail: function(ex) {\n        // eslint-disable-next-line no-console\n        console.log(\"ex:\" + ex);\n    },\n}]);\n}\n\n/**\n * Function to collect checked idboxes.\n * @param {*} id\n * @param {*} idstring\n * @param {*} data\n * @returns {object}\n */\nfunction getIds(id, idstring, data) {\n\n  var checkedids = [];\n  const labelarray = [];\n\n  // If the id is 0, we return for all checked checkboxes.\n  // if not, just for the current one.\n  if (id < 1) {\n    const container = document.querySelector('#a' + idstring);\n    const checkboxes = container.querySelectorAll(SELECTOR.CHECKBOX);\n\n    // Create an array of ids of the checked boxes.\n    checkboxes.forEach(x => {\n\n        if (x.checked) {\n\n          try {\n            const name = container.querySelector('[data-id=\"' + x.id + '\"] [data-label=\"' + data.labelcolumn + '\"]').textContent;\n            labelarray.push(name);\n          } catch (e) {\n            labelarray.push(x.id);\n          }\n\n          checkedids.push(x.id);\n      }\n    });\n\n    data.checkedids = checkedids;\n  } else {\n    checkedids = [id];\n  }\n\n  return {\n    'checkedids': checkedids,\n    'labelarray': labelarray,\n  };\n}"],"names":["selector","idstring","encodedtable","container","document","querySelector","querySelectorAll","SELECTOR","forEach","button","dataset","initialized","methodname","length","addEventListener","nomodal","id","transmitAction","JSON","stringify","data","result","checkedids","labelarray","x","checked","name","labelcolumn","textContent","push","e","getIds","message","datastring","join","strings","key","titlestring","component","bodystring","param","submitbuttonstring","localizedstrings","create","type","ModalFactory","types","SAVE_CANCEL","then","modal","setTitle","setBody","setSaveButtonText","getRoot","on","ModalEvents","save","cid","show","catch","console","log","showConfirmationModal","call","args","parseInt","done","success","fail","ex"],"mappings":";;;;;sGA0CwCA,SAAUC,SAAUC,oBAEhDC,UAAYC,SAASC,cAAcL,UACnBG,UAAUG,iBAAiBC,uBAEnCC,SAAQC,SACdA,OAAOC,QAAQC,aAIsB,IAArCF,OAAOC,QAAQE,WAAWC,SAI9BJ,OAAOC,QAAQC,aAAc,EAE7BF,OAAOK,iBAAiB,SAAS,KAE3BL,OAAOC,QAAQK,SAAWN,OAAOC,QAAQM,GAAK,EAEhDC,eAAeR,OAAOC,QAAQM,GAAIP,OAAOC,QAAQE,WAAYM,KAAKC,UAAUV,OAAOC,SAAUT,SAAUC,6BAchFO,OAAQR,SAAUC,+KAE/Cc,GAAKP,OAAOC,QAAQM,GACpBJ,WAAaH,OAAOC,QAAQE,WAC5BQ,KAAOX,OAAOC,QAEdW,gBAuGQL,GAAIf,SAAUmB,UAExBE,WAAa,SACXC,WAAa,MAIfP,GAAK,EAAG,OACJb,UAAYC,SAASC,cAAc,KAAOJ,UAC7BE,UAAUG,iBAAiBC,mBAGnCC,SAAQgB,OAEXA,EAAEC,QAAS,WAGLC,KAAOvB,UAAUE,cAAc,aAAemB,EAAER,GAAK,mBAAqBI,KAAKO,YAAc,MAAMC,YACzGL,WAAWM,KAAKH,MAChB,MAAOI,GACPP,WAAWM,KAAKL,EAAER,IAGpBM,WAAWO,KAAKL,EAAER,QAIxBI,KAAKE,WAAaA,gBAElBA,WAAa,CAACN,UAGT,YACSM,sBACAC,YAzIDQ,CAAOf,GAAIf,SAAUmB,UAEhCE,WAAaD,OAAOC,iBAClBC,WAAaF,OAAOE,cAEtBD,WAAWT,OAAS,EAAG,OACnBmB,cAAgB,mBAAU,oBAAqB,yEACpCA,QAAS,gBAItBC,oCAAaV,WAAWW,KAAK,qDAAW,OAE1CC,QAAU,CACZ,CACEC,kCAAK3B,OAAOC,QAAQ2B,mEAAe,eACnCC,wCAAW7B,OAAOC,QAAQ4B,iEAAa,0BAEzC,CACEF,kCAAK3B,OAAOC,QAAQ6B,kEAAc,cAClCD,yCAAW7B,OAAOC,QAAQ4B,mEAAa,yBACvCE,MAAO,CAELpB,KAAMa,aAGV,CACEG,kCAAK3B,OAAOC,QAAQ+B,0EAAsB,gBAC1CH,yCAAW7B,OAAOC,QAAQ4B,mEAAa,iCAIrCI,uBAAyB,oBAAWP,gCAE7BQ,OAAO,CAACC,KAAMC,uBAAaC,MAAMC,cAAcC,MAAKC,QAE/DA,MAAMC,SAASR,iBAAiB,IAC5BO,MAAME,QAAQT,iBAAiB,IAC/BO,MAAMG,kBAAkBV,iBAAiB,IACzCO,MAAMI,UAAUC,GAAGC,sBAAYC,MAAM,WAGvB,GAANxC,GACFC,eAAeD,GAAIJ,WAAYM,KAAKC,UAAUC,MAAOnB,SAAUC,cAG/DoB,WAAWd,SAAQiD,MACjBxC,eAAewC,IAAK7C,WAAYM,KAAKC,UAAUC,MAAOnB,SAAUC,oBAKxE+C,MAAMS,OACCT,SACVU,OAAM7B,IAEL8B,QAAQC,IAAI/B,MA1EJgC,CAAsBrD,OAAQR,SAAUC,0KAlChDK,sBACU,oBADVA,kBAEM,6BAsHHU,eAAeD,GAAIJ,WAAYqB,WAAYhC,SAAUC,4BACvD6D,KAAK,CAAC,CACTnD,WAAY,wCACZoD,KAAM,IACIC,SAASjD,eACDJ,gBACNqB,wBACQ/B,cAEpBgE,KAAM,SAAS9C,MAES,GAAhBA,KAAK+C,4CAEU/C,KAAKY,QAAS,+CAEdZ,KAAKY,QAAS,yCAMrCoC,KAAM,SAASC,IAEXT,QAAQC,IAAI,MAAQQ"}